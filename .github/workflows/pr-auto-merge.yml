name: PR Auto Merge

on:
  pull_request:
    types: [labeled, unlabeled]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  status: {}

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  auto-merge:
    name: Auto Merge PR
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.state == 'open' &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge') &&
      !contains(github.event.pull_request.labels.*.name, 'hold')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Load Auto-Review Config
        id: config
        run: |
          if [ -f .github/auto-review-config.yml ]; then
            cat .github/auto-review-config.yml
          else
            echo "Config file not found"
          fi

      - name: Check Merge Conditions
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });
            
            // Check for conflicts
            if (pr.mergeable === false) {
              core.setOutput('ready', 'false');
              core.setOutput('reason', 'PR has conflicts');
              return false;
            }
            
            // Check if PR is mergeable
            if (pr.mergeable_state !== 'clean' && pr.mergeable_state !== 'unstable') {
              core.setOutput('ready', 'false');
              core.setOutput('reason', `PR mergeable state: ${pr.mergeable_state}`);
              return false;
            }
            
            // Get all check runs
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: pr.head.sha
            });
            
            // Check if all required checks passed
            const failedChecks = checkRuns.check_runs.filter(
              check => check.conclusion !== 'success' && check.conclusion !== 'skipped'
            );
            
            if (failedChecks.length > 0) {
              core.setOutput('ready', 'false');
              core.setOutput('reason', `Failed checks: ${failedChecks.map(c => c.name).join(', ')}`);
              return false;
            }
            
            // Check reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner,
              repo,
              pull_number
            });
            
            const latestReviews = reviews.reduce((acc, review) => {
              acc[review.user.login] = review;
              return acc;
            }, {});
            
            const approvals = Object.values(latestReviews).filter(
              review => review.state === 'APPROVED'
            ).length;
            
            if (approvals < 1) {
              core.setOutput('ready', 'false');
              core.setOutput('reason', 'Needs at least 1 approval');
              return false;
            }
            
            // Check for requested changes
            const changesRequested = Object.values(latestReviews).some(
              review => review.state === 'CHANGES_REQUESTED'
            );
            
            if (changesRequested) {
              core.setOutput('ready', 'false');
              core.setOutput('reason', 'Changes requested');
              return false;
            }
            
            core.setOutput('ready', 'true');
            core.setOutput('reason', 'All conditions met');
            return true;

      - name: Determine Merge Strategy
        id: strategy
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(l => l.name);
            
            let strategy = 'squash'; // default
            
            if (labels.includes('merge-rebase')) {
              strategy = 'rebase';
            } else if (labels.includes('merge-commit')) {
              strategy = 'merge';
            }
            
            core.setOutput('method', strategy);
            return strategy;

      - name: Run Pre-Merge Checks
        if: steps.check.outputs.ready == 'true'
        run: |
          node scripts/auto-merger.js --check \
            --pr-number=${{ github.event.pull_request.number }} \
            --merge-method=${{ steps.strategy.outputs.method }}

      - name: Merge PR
        if: steps.check.outputs.ready == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pull_number = context.payload.pull_request.number;
            const mergeMethod = '${{ steps.strategy.outputs.method }}';
            
            try {
              const { data: result } = await github.rest.pulls.merge({
                owner,
                repo,
                pull_number,
                merge_method: mergeMethod,
                commit_title: `Merge PR #${pull_number}: ${context.payload.pull_request.title}`,
                commit_message: `Auto-merged by PR Auto-Merge workflow\n\nAll checks passed and conditions met.`
              });
              
              console.log(`‚úÖ PR merged successfully: ${result.sha}`);
              core.setOutput('merged', 'true');
              core.setOutput('sha', result.sha);
              
              // Delete branch after merge
              try {
                await github.rest.git.deleteRef({
                  owner,
                  repo,
                  ref: `heads/${context.payload.pull_request.head.ref}`
                });
                console.log(`üóëÔ∏è Branch deleted: ${context.payload.pull_request.head.ref}`);
              } catch (error) {
                console.log(`‚ö†Ô∏è Could not delete branch: ${error.message}`);
              }
              
            } catch (error) {
              console.log(`‚ùå Merge failed: ${error.message}`);
              core.setOutput('merged', 'false');
              throw error;
            }

      - name: Comment Merge Success
        if: steps.check.outputs.ready == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## üéâ Auto-Merge Successful
            
            This PR has been automatically merged using **${{ steps.strategy.outputs.method }}** strategy.
            
            - üîÄ Merge SHA: \`${{ steps.merge.outputs.sha }}\`
            - üóëÔ∏è Branch deleted: \`${{ github.event.pull_request.head.ref }}\`
            - ‚è±Ô∏è Merged at: ${new Date().toISOString()}
            
            Thank you for your contribution! üöÄ
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Comment Not Ready
        if: steps.check.outputs.ready != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ steps.check.outputs.reason }}';
            
            const comment = `## ‚è∏Ô∏è Auto-Merge Pending
            
            This PR is not ready for auto-merge yet.
            
            **Reason:** ${reason}
            
            The PR will be automatically merged once all conditions are met.
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Notify on Success
        if: steps.check.outputs.ready == 'true' && (secrets.SLACK_WEBHOOK != '' || secrets.DISCORD_WEBHOOK != '')
        run: |
          node scripts/auto-merger.js --notify \
            --pr-number=${{ github.event.pull_request.number }} \
            --pr-title="${{ github.event.pull_request.title }}" \
            --pr-author="${{ github.event.pull_request.user.login }}" \
            --merge-sha="${{ steps.merge.outputs.sha }}"
